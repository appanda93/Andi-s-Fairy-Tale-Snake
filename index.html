<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fairytale Snake ü¶ã</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Sacramento&display=swap" rel="stylesheet">
  <style>
    :root { --card:#fffafa; --border:#d8b4f8; --shadow:rgba(200,150,255,.4); --ink:#6a1b9a; }
    html, body { height: 100%; }
    body {
      margin: 0; display: grid; place-items: center;
      background: linear-gradient(135deg,#ffe6f0,#e6f7ff);
      font-family: 'Poppins', sans-serif; color: var(--ink);
      overflow: hidden; height: 100vh; position: relative;
    }
    h1, h2, #scoreBoard { font-family: 'Sacramento', cursive; }

    #scoreBoard {
      font-size: 28px;
      text-shadow: 0 0 8px #ff99cc,0 0 12px #cc99ff,0 0 18px #ffe6ff;
      display: none; user-select: none;
      position: relative; z-index: 4;
    }
    #musicBtn { position: absolute; top: 10px; right: 10px; display: none; z-index: 4; }

    /* Game canvas */
    #gameCanvas {
      background: var(--card); border: 4px solid var(--border); border-radius: 14px;
      box-shadow: 0 10px 30px var(--shadow); display: none; touch-action: none; z-index: 1;
    }

    /* Confetti overlay canvas (on top of everything) */
    #fxCanvas {
      position: absolute; inset: 0;
      pointer-events: none; z-index: 999;
    }

    .menu, .game-over { text-align: center; z-index: 4; }
    .menu h1, .game-over h1 {
      font-size: 50px; margin-bottom: 10px;
      text-shadow: 0 0 8px #ff99cc, 0 0 12px #cc99ff; user-select: none;
    }
    .menu .best, .game-over .best {
      margin-top: 4px; font-size: 16px; opacity: 0.85;
    }
    .menu button, .game-over button, #musicBtn, .modal button {
      font-size: 20px; padding: 10px 20px; margin: 10px; border: none; border-radius: 10px;
      background: #f7d9f0; cursor: pointer; box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      transition: transform .15s ease, background .15s ease;
    }
    .menu button:hover, .game-over button:hover, #musicBtn:hover, .modal button:hover {
      background: #e6c7ff; transform: scale(1.05);
    }

    .firefly {
      position: absolute; width: 6px; height: 6px; background: #ffff99; border-radius: 50%;
      box-shadow: 0 0 8px 4px rgba(255,255,150,0.6); animation: float 10s linear infinite;
      pointer-events: none; z-index: 0;
    }
    @keyframes float { from{transform:translateY(100vh);opacity:0;} 50%{opacity:1;} to{transform:translateY(-10vh);opacity:0;} }

    .game-over { display: none; }

    /* Modal */
    .backdrop {
      position: fixed; inset: 0; background: rgba(0,0,0,0.35);
      display: none; align-items: center; justify-content: center; padding: 20px; z-index: 10;
    }
    .modal {
      max-width: 520px; width: 100%; background: var(--card); border: 4px solid var(--border);
      border-radius: 16px; box-shadow: 0 10px 30px rgba(200,150,255,.5);
      padding: 18px 20px 8px; text-align: left; color: var(--ink);
    }
    .modal h2 { margin: 0 0 8px; font-size: 32px; text-align: center; text-shadow: 0 0 8px #ff99cc, 0 0 12px #cc99ff; }
    .modal ul { margin: 8px 0 0 18px; padding: 0; line-height: 1.35; font-size: 18px; }
    .modal .actions { display: flex; justify-content: center; margin-top: 14px; margin-bottom: 6px; }
  </style>
</head>
<body>
  <!-- Start Menu -->
  <div class="menu" id="startMenu">
    <h1>Andi's Fairytale Snake üßö‚Äç‚ôÄÔ∏è</h1>
    <div class="best" id="bestOnMenu">Best: 0</div>
    <p>Select difficulty:</p>
    <button id="btnEasy">Easy</button>
    <button id="btnMedium">Medium</button>
    <button id="btnHard">Hard</button>
    <div>
      <button id="btnOpenHowTo">How to Play</button>
      <button id="btnResetBest" title="Clear saved high score">Reset High Score</button>
    </div>
  </div>

  <!-- Score + Canvas -->
  <div id="scoreBoard">Score: 0 &nbsp;|&nbsp; üëë Best: 0</div>
  <canvas id="gameCanvas"></canvas>
  <button id="musicBtn">üîä Music On</button>

  <!-- Confetti overlay (full-screen) -->
  <canvas id="fxCanvas"></canvas>

  <!-- Instructions Modal -->
  <div class="backdrop" id="howtoBackdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="howtoTitle">
      <h2 id="howtoTitle">How to Play ü¶ã</h2>
      <ul>
        <li><b>Goal:</b> Eat cupcakes, mushrooms, and crystals to score points. Woo!</li>
        <li><b>Move:</b> Swipe up, down, left, or right in the direction you want to go. Don't swipe backwards!</li>
        <li><b>Desktop:</b> Use the arrow keys.</li>
        <li><b>Avoid:</b> Don‚Äôt hit the walls or your own tail. Yikes!!</li>
        <li><b>Music:</b> Use the üîä button to toggle background music.</li>
      </ul>
      <div class="actions"><button id="btnCloseHowTo">Got it ‚ú®</button></div>
    </div>
  </div>

  <!-- Game Over Screen -->
  <div class="game-over" id="gameOverMenu">
    <h1>Game Over ü¶ã</h1>
    <p id="finalScore"></p>
    <div class="best" id="bestOnOver">Best: 0</div>
    <button id="btnReplay">Play Again</button>
  </div>

  <script>
    // Fireflies (visual only)
    for (let i = 0; i < 15; i++) {
      const f = document.createElement('div');
      f.className = 'firefly';
      f.style.left = Math.random() * 100 + 'vw';
      f.style.animationDuration = (8 + Math.random() * 5) + 's';
      document.body.appendChild(f);
    }

    document.addEventListener('DOMContentLoaded', () => {
      // Elements
      const canvas = document.getElementById('gameCanvas');
      const ctx = canvas.getContext('2d');
      const scoreBoard = document.getElementById('scoreBoard');
      const startMenu = document.getElementById('startMenu');
      const gameOverMenu = document.getElementById('gameOverMenu');
      const finalScore = document.getElementById('finalScore');
      const musicBtn = document.getElementById('musicBtn');
      const howtoBackdrop = document.getElementById('howtoBackdrop');
      const bestOnMenu = document.getElementById('bestOnMenu');
      const bestOnOver = document.getElementById('bestOnOver');

      // Confetti overlay
      const fx = document.getElementById('fxCanvas');
      const fxx = fx.getContext('2d');

      // Buttons
      const btnEasy = document.getElementById('btnEasy');
      const btnMedium = document.getElementById('btnMedium');
      const btnHard = document.getElementById('btnHard');
      const btnReplay = document.getElementById('btnReplay');
      const btnOpenHowTo = document.getElementById('btnOpenHowTo');
      const btnCloseHowTo = document.getElementById('btnCloseHowTo');
      const btnResetBest = document.getElementById('btnResetBest');

      // Game state
      const gridSize = 20;
      let snake, dx, dy, food, score, game, speed;
      const pastelColors = ['#fbb1bd','#c1f0f6','#f7d9f0','#d4f7d0','#fef3bd'];
      const foodTypes = ['cupcake','mushroom','crystal'];

      // High score (persistent)
      const BEST_KEY = 'fairytale_snake_best';
      let best = parseInt(localStorage.getItem(BEST_KEY) || '0', 10);
      updateBestDisplays();

      // Audio (created on first click)
      let harpMusic = null;
      let musicOn = false;

      // Responsive sizes
      function resizeCanvas() {
        const size = Math.min(window.innerWidth * 0.9, window.innerHeight * 0.7, 400);
        canvas.width = size;
        canvas.height = size;

        fx.width = window.innerWidth;
        fx.height = window.innerHeight;
      }
      window.addEventListener('resize', resizeCanvas);

      // Music toggle
      function toggleMusic() {
        if (!harpMusic) return;
        if (musicOn) {
          harpMusic.pause();
          musicBtn.textContent = "üîá Music Off";
        } else {
          harpMusic.play().catch(err => console.log("Audio blocked:", err));
          musicBtn.textContent = "üîä Music On";
        }
        musicOn = !musicOn;
      }

      // Food & draw
      function randomFood() {
        const type = foodTypes[Math.floor(Math.random() * foodTypes.length)];
        return {
          x: Math.floor(Math.random() * (canvas.width / gridSize)) * gridSize,
          y: Math.floor(Math.random() * (canvas.height / gridSize)) * gridSize,
          type
        };
      }

      function drawSnake() {
        snake.forEach((part, i) => {
          const r = gridSize/2 - 2;
          const cx = part.x + gridSize/2;
          const cy = part.y + gridSize/2;
          ctx.fillStyle = pastelColors[i % pastelColors.length];
          ctx.beginPath();
          ctx.arc(cx, cy, r, 0, Math.PI*2);
          ctx.fill();
        });
      }

      function drawFood() {
        const {x, y, type} = food;
        ctx.save();
        ctx.translate(x + gridSize/2, y + gridSize/2);
        if (type === 'cupcake') {
          ctx.fillStyle = '#ffb6c1';
          ctx.beginPath(); ctx.arc(0, 0, 8, Math.PI, 0); ctx.fill();
          ctx.fillStyle = '#ff69b4'; ctx.fillRect(-8, 0, 16, 8);
        } else if (type === 'mushroom') {
          ctx.fillStyle = '#ff4444';
          ctx.beginPath(); ctx.arc(0, 0, 10, Math.PI, 0); ctx.fill();
          ctx.fillStyle = '#fff';
          ctx.beginPath(); ctx.arc(-4,-2,2,0,Math.PI*2); ctx.arc(4,-2,2,0,Math.PI*2); ctx.fill();
          ctx.fillStyle = '#d2b48c'; ctx.fillRect(-4, 0, 8, 8);
        } else if (type === 'crystal') {
          ctx.fillStyle = '#99ccff';
          ctx.beginPath(); ctx.moveTo(0,-8); ctx.lineTo(6,0); ctx.lineTo(0,8); ctx.lineTo(-6,0); ctx.closePath(); ctx.fill();
        }
        ctx.restore();
      }

      // Movement & collisions
      function moveSnake() {
        const head = { x: snake[0].x + dx, y: snake[0].y + dy };
        snake.unshift(head);
        if (head.x === food.x && head.y === food.y) {
          score++;
          scoreBoard.textContent = `Score: ${score}  |  üëë Best: ${best}`;
          food = randomFood();
        } else {
          snake.pop();
        }
      }

      function checkCollision() {
        const h = snake[0];
        const hitWall = h.x < 0 || h.x >= canvas.width || h.y < 0 || h.y >= canvas.height;
        const hitSelf = snake.slice(1).some(p => p.x === h.x && p.y === h.y);
        if (hitWall || hitSelf) {
          clearInterval(game);
          gameOver();
        }
      }

      function gameLoop() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        moveSnake();
        checkCollision();
        drawSnake();
        drawFood();
      }

      // Keyboard (desktop)
      document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowUp'    && dy === 0) { dx = 0; dy = -gridSize; }
        else if (e.key === 'ArrowDown'  && dy === 0) { dx = 0; dy =  gridSize; }
        else if (e.key === 'ArrowLeft'  && dx === 0) { dx = -gridSize; dy = 0; }
        else if (e.key === 'ArrowRight' && dx === 0) { dx =  gridSize; dy = 0; }
        else if (e.key === 'Escape' && howtoBackdrop.style.display === 'flex') closeHowToModal();
      });

      // Swipe (mobile)
      let touchStartX = 0, touchStartY = 0;
      canvas.addEventListener('touchstart', (e) => {
        const t = e.touches[0]; touchStartX = t.clientX; touchStartY = t.clientY;
      }, { passive: true });
      canvas.addEventListener('touchend', (e) => {
        const t = e.changedTouches[0];
        const dxTouch = t.clientX - touchStartX;
        const dyTouch = t.clientY - touchStartY;
        if (Math.abs(dxTouch) > Math.abs(dyTouch)) {
          if (dxTouch > 30 && dx !== -gridSize) { dx =  gridSize; dy = 0; }
          else if (dxTouch < -30 && dx !==  gridSize) { dx = -gridSize; dy = 0; }
        } else {
          if (dyTouch > 30 && dy !== -gridSize) { dx = 0; dy =  gridSize; }
          else if (dyTouch < -30 && dy !==  gridSize) { dx = 0; dy = -gridSize; }
        }
      }, { passive: true });

      // High score helpers
      function updateBestDisplays() {
        bestOnMenu.textContent = `Best: ${best}`;
        bestOnOver.textContent = `Best: ${best}`;
        const currentScoreText = (scoreBoard.textContent.split('|')[0] || 'Score: 0 ').trim();
        scoreBoard.textContent = `${currentScoreText}  |  üëë Best: ${best}`;
      }

      function maybeSetNewBest() {
        if (score > best) {
          best = score;
          localStorage.setItem(BEST_KEY, String(best));
          updateBestDisplays();
          launchConfetti(); // üéâ celebrate!
        }
      }

      // Confetti engine (tiny + fast)
      let confettiAnim = null;
      function launchConfetti() {
        // generate particles
        const count = 140; // nice burst
        const particles = [];
        const colors = ['#ff99cc','#c1f0f6','#f7d9f0','#d4f7d0','#fef3bd','#b39ddb'];
        const w = fx.width = window.innerWidth;
        const h = fx.height = window.innerHeight;
        for (let i = 0; i < count; i++) {
          const angle = Math.random() * Math.PI - Math.PI / 2; // left/up to right/up
          const speed = 6 + Math.random() * 6;
          particles.push({
            x: w / 2,
            y: h * 0.3,           // a bit above center
            vx: Math.cos(angle) * speed,
            vy: Math.sin(angle) * speed - 2,
            g: 0.25 + Math.random() * 0.2, // gravity
            life: 60 + Math.random() * 40,  // frames
            color: colors[Math.floor(Math.random() * colors.length)],
            size: 4 + Math.random() * 4,
            rot: Math.random() * Math.PI,
            vr: (Math.random() - 0.5) * 0.3
          });
        }

        // run animation ~2s
        cancelAnimationFrame(confettiAnim);
        let frame = 0;
        function tick() {
          frame++;
          fxx.clearRect(0, 0, fx.width, fx.height);
          for (const p of particles) {
            // Update
            p.vy += p.g;
            p.x += p.vx;
            p.y += p.vy;
            p.rot += p.vr;
            p.life--;

            // Draw (little rectangles / slivers)
            fxx.save();
            fxx.translate(p.x, p.y);
            fxx.rotate(p.rot);
            fxx.fillStyle = p.color;
            fxx.fillRect(-p.size/2, -p.size/2, p.size, p.size * 1.6);
            fxx.restore();
          }
          // Keep only alive & on screen
          for (let i = particles.length - 1; i >= 0; i--) {
            const p = particles[i];
            if (p.life <= 0 || p.y > fx.height + 40) particles.splice(i, 1);
          }
          if (particles.length > 0 && frame < 180) {
            confettiAnim = requestAnimationFrame(tick);
          } else {
            fxx.clearRect(0, 0, fx.width, fx.height);
          }
        }
        tick();
      }

      // Start / Game Over
      function startGame(selectedSpeed) {
        startMenu.style.display = 'none';
        gameOverMenu.style.display = 'none';
        canvas.style.display = 'block';
        scoreBoard.style.display = 'block';
        musicBtn.style.display = 'block';

        resizeCanvas();

        snake = [{ x: gridSize*5, y: gridSize*5 }];
        dx = gridSize; dy = 0;
        food = randomFood();
        score = 0;
        scoreBoard.textContent = `Score: 0  |  üëë Best: ${best}`;
        speed = selectedSpeed;
        clearInterval(game);
        game = setInterval(gameLoop, speed);

        if (!harpMusic) {
          harpMusic = new Audio("Lofi.mp3");
          harpMusic.loop = true;
          harpMusic.volume = 0.6;
        }
        harpMusic.play().then(() => {
          musicOn = true;
          musicBtn.textContent = "üîä Music On";
        }).catch(err => console.log("Autoplay blocked:", err));
      }

      function gameOver() {
        maybeSetNewBest();
        canvas.style.display = 'none';
        scoreBoard.style.display = 'none';
        musicBtn.style.display = 'none';
        gameOverMenu.style.display = 'block';
        finalScore.textContent = `Your score: ${score}`;
        bestOnOver.textContent = `Best: ${best}`;
        if (harpMusic) harpMusic.pause();
      }

      function restartGame() {
        startMenu.style.display = 'block';
        gameOverMenu.style.display = 'none';
        updateBestDisplays();
      }

      // Modal helpers
      function openHowToModal() { howtoBackdrop.style.display = 'flex'; }
      function closeHowToModal() { howtoBackdrop.style.display = 'none'; }
      howtoBackdrop.addEventListener('click', (e) => {
        if (e.target === howtoBackdrop) closeHowToModal();
      });

      // Reset best
      function resetBest() {
        if (confirm('Reset your saved high score?')) {
          best = 0;
          localStorage.setItem(BEST_KEY, '0');
          updateBestDisplays();
        }
      }

      // Wire buttons
      btnEasy.addEventListener('click', () => startGame(200));
      btnMedium.addEventListener('click', () => startGame(120));
      btnHard.addEventListener('click', () => startGame(70));
      btnReplay.addEventListener('click', restartGame);
      musicBtn.addEventListener('click', toggleMusic);
      btnOpenHowTo.addEventListener('click', openHowToModal);
      btnCloseHowTo.addEventListener('click', closeHowToModal);
      btnResetBest.addEventListener('click', resetBest);
    });
  </script>
</body>
</html>
